generator client {
  provider      = "prisma-client-js"
  /// Ensure Prisma generates engines compatible with Debian OpenSSL 3.0 runtimes
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SaleStatus {
  SUCCESS
  FAILED
  PROCESSING
}

model Sale {
  id            Int         @id @default(autoincrement())
  receiptNo     String      @unique
  total         Decimal     @db.Decimal(12, 2)
  paymentMethod String
  status        SaleStatus  @default(SUCCESS)
  items         Json
  reference     String?
  locationId    String?
  createdAt     DateTime    @default(now())
  fiscalMetadata Json?
  documents     DeliveryDocument[]
  cashEvents    CashEvent[]
  preorder      Preorder?
}

enum PreorderStatus {
  ORDERED
  READY
  PICKED_UP
}

enum DeliveryDocumentType {
  DELIVERY_NOTE
  PICKUP_RECEIPT
}

enum CashEventType {
  SALE_COMPLETED
  PREORDER_READY
  PREORDER_PICKED_UP
}

enum ReportExportType {
  SALES_SUMMARY
  EMPLOYEE_PERFORMANCE
  CATEGORY_PERFORMANCE
}

enum ReportExportFormat {
  CSV
  XLSX
}

enum ReportExportStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

model ReportExport {
  id                Int               @id @default(autoincrement())
  type              ReportExportType
  format            ReportExportFormat
  status            ReportExportStatus @default(PENDING)
  fingerprint       String            @unique
  filters           Json?
  fromDate          DateTime?
  toDate            DateTime?
  granularity       String?
  locationId        String?
  notificationEmail String?
  fileName          String?
  mimeType          String?
  fileData          Bytes?
  error             String?
  createdAt         DateTime          @default(now())
  startedAt         DateTime?
  completedAt       DateTime?

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Preorder {
  id                Int                       @id @default(autoincrement())
  tenantId          String?
  externalReference String                    @unique
  customerName      String?
  scheduledPickup   DateTime?
  status            PreorderStatus            @default(ORDERED)
  items             Json
  notes             String?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  saleId            Int?        @unique
  woltOrderId       Int?
  sale              Sale?                     @relation(fields: [saleId], references: [id], onDelete: SetNull)
  woltOrder         WoltOrder?                @relation(fields: [woltOrderId], references: [id], onDelete: SetNull)
  statusHistory     PreorderStatusTransition[]
  documents         DeliveryDocument[]
  cashEvents        CashEvent[]

  @@index([externalReference])
  @@index([status])
}

model PreorderStatusTransition {
  id         Int            @id @default(autoincrement())
  preorderId Int
  status     PreorderStatus
  notes      String?
  createdAt  DateTime       @default(now())
  preorder   Preorder       @relation(fields: [preorderId], references: [id], onDelete: Cascade)

  @@index([preorderId])
}

model DeliveryDocument {
  id             Int                 @id @default(autoincrement())
  preorderId     Int?
  saleId         Int?
  type           DeliveryDocumentType
  documentNumber String              @unique
  payload        Json
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  preorder       Preorder?           @relation(fields: [preorderId], references: [id], onDelete: SetNull)
  sale           Sale?               @relation(fields: [saleId], references: [id], onDelete: SetNull)

  @@index([preorderId])
  @@index([saleId])
}

model CashEvent {
  id         Int           @id @default(autoincrement())
  saleId     Int?
  preorderId Int?
  type       CashEventType
  metadata   Json?
  createdAt  DateTime      @default(now())
  sale       Sale?         @relation(fields: [saleId], references: [id], onDelete: SetNull)
  preorder   Preorder?     @relation(fields: [preorderId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([saleId])
  @@index([preorderId])
}

model WoltProduct {
  id          Int       @id @default(autoincrement())
  externalId  String    @unique
  tenantId    String?
  name        String
  price       Decimal   @db.Decimal(12, 2)
  rawPayload  Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
}

model WoltOrder {
  id          Int        @id @default(autoincrement())
  externalId  String     @unique
  tenantId    String?
  status      String
  rawPayload  Json
  preorder    Preorder[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tenantId])
  @@index([status])
}

model Tenant {
  id               String         @id
  name             String
  fiskalyApiKey    String
  fiskalyApiSecret String
  fiskalyClientId  String
  isDefault        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  tsses            Tss[]
  cashRegisters    CashRegister[]
  suppliers        Supplier[]
  products         Product[]
  storageLocations StorageLocation[]
  goodsReceipts    GoodsReceipt[]
  inventoryCounts  InventoryCount[]
  priceHistories   PriceHistory[]
  promotions       Promotion[]
}

model Tss {
  id           String         @id
  serialNumber String?
  description  String?
  state        String?
  tenantId     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashRegisters CashRegister[]
}

model CashRegister {
  id        String   @id
  label     String?
  tenantId  String
  tssId     String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tss       Tss      @relation(fields: [tssId], references: [id], onDelete: Cascade)
}

enum InventoryCountStatus {
  OPEN
  COMPLETED
}

model Supplier {
  id                Int                @id @default(autoincrement())
  tenantId          String
  name              String
  bnnSupplierNumber String?
  contactEmail      String?
  phone             String?
  address           String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  goodsReceipts     GoodsReceipt[]
  batches           Batch[]
  products          Product[]

  @@index([tenantId])
}

model Product {
  id           Int                @id @default(autoincrement())
  tenantId     String
  supplierId   Int?
  sku          String
  name         String
  unit         String             @default("pcs")
  defaultPrice Decimal            @db.Decimal(12, 2)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier     Supplier?          @relation(fields: [supplierId], references: [id])
  batches      Batch[]
  receiptItems GoodsReceiptItem[]
  countItems   InventoryCountItem[]
  adjustments  InventoryAdjustment[]
  priceHistory PriceHistory[]

  @@unique([tenantId, sku])
  @@index([supplierId])
}

model StorageLocation {
  id          Int         @id @default(autoincrement())
  tenantId    String
  code        String
  description String?
  type        String?     @default("GENERAL")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  batches     Batch[]
  counts      InventoryCount[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

model Batch {
  id                Int                   @id @default(autoincrement())
  productId         Int
  supplierId        Int?
  storageLocationId Int?
  lotNumber         String
  quantity          Decimal               @db.Decimal(12, 3)
  unitCost          Decimal?              @db.Decimal(12, 4)
  expirationDate    DateTime?
  receivedAt        DateTime              @default(now())
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier          Supplier?             @relation(fields: [supplierId], references: [id])
  storageLocation   StorageLocation?      @relation(fields: [storageLocationId], references: [id])
  receiptItems      GoodsReceiptItem[]
  countItems        InventoryCountItem[]
  adjustments       InventoryAdjustment[]

  @@index([productId])
  @@index([lotNumber])
}

model GoodsReceipt {
  id            Int                    @id @default(autoincrement())
  tenantId      String
  supplierId    Int?
  reference     String?
  receivedAt    DateTime               @default(now())
  notes         String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier      Supplier?              @relation(fields: [supplierId], references: [id])
  items         GoodsReceiptItem[]
  importSources GoodsReceiptImportLog[]

  @@index([tenantId])
  @@index([supplierId])
}

model GoodsReceiptItem {
  id             Int           @id @default(autoincrement())
  goodsReceiptId Int
  productId      Int
  batchId        Int?
  quantity       Decimal       @db.Decimal(12, 3)
  unitCost       Decimal       @db.Decimal(12, 4)
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  goodsReceipt   GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  product        Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch          Batch?        @relation(fields: [batchId], references: [id])

  @@index([goodsReceiptId])
  @@index([productId])
}

model GoodsReceiptImportLog {
  id             Int          @id @default(autoincrement())
  goodsReceiptId Int
  format         String
  sourceFileName String?
  rawPayload     String
  createdAt      DateTime     @default(now())
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
}

model InventoryCount {
  id          Int                   @id @default(autoincrement())
  tenantId    String
  locationId  Int?
  status      InventoryCountStatus   @default(OPEN)
  startedAt   DateTime               @default(now())
  completedAt DateTime?
  tenant      Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location    StorageLocation?       @relation(fields: [locationId], references: [id])
  items       InventoryCountItem[]
  adjustments InventoryAdjustment[]

  @@index([tenantId])
  @@index([locationId])
}

model InventoryCountItem {
  id               Int               @id @default(autoincrement())
  inventoryCountId Int
  productId        Int
  batchId          Int?
  expectedQuantity Decimal?          @db.Decimal(12, 3)
  countedQuantity  Decimal           @db.Decimal(12, 3)
  difference       Decimal           @db.Decimal(12, 3)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  inventoryCount   InventoryCount    @relation(fields: [inventoryCountId], references: [id], onDelete: Cascade)
  product          Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch            Batch?            @relation(fields: [batchId], references: [id])

  @@index([inventoryCountId])
  @@index([productId])
}

model InventoryAdjustment {
  id               Int             @id @default(autoincrement())
  inventoryCountId Int?
  productId        Int
  batchId          Int?
  quantityChange   Decimal         @db.Decimal(12, 3)
  reason           String?
  createdAt        DateTime        @default(now())
  inventoryCount   InventoryCount? @relation(fields: [inventoryCountId], references: [id])
  product          Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch            Batch?          @relation(fields: [batchId], references: [id])

  @@index([inventoryCountId])
  @@index([productId])
}

model Promotion {
  id          Int           @id @default(autoincrement())
  tenantId    String
  name        String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  priceEvents PriceHistory[]

  @@index([tenantId])
}

model PriceHistory {
  id            Int        @id @default(autoincrement())
  tenantId      String
  productId     Int
  oldPrice      Decimal    @db.Decimal(12, 2)
  newPrice      Decimal    @db.Decimal(12, 2)
  reason        String?
  effectiveFrom DateTime   @default(now())
  effectiveTo   DateTime?
  promotionId   Int?
  createdAt     DateTime   @default(now())
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  promotion     Promotion? @relation(fields: [promotionId], references: [id])

  @@index([tenantId])
  @@index([productId])
}

model User {
  id             Int         @id @default(autoincrement())
  tenantId       String?
  email          String      @unique
  name           String
  hashedPassword String
  isActive       Boolean     @default(true)
  lastLoginAt    DateTime?
  metadata       Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  roles          UserRole[]
  auditLogs      AuditLog[]
  exportLogs     DatevExportLog[] @relation("DatevExportsTriggered")
  csvPresets     CsvExportPreset[] @relation("CsvPresetOwners")
  assignedRoles  UserRole[]        @relation("UserRoleAssignedBy")
  grantedPermissions RolePermission[] @relation("RolePermissionAssignedBy")

  @@index([tenantId])
}

model Role {
  id           Int              @id @default(autoincrement())
  tenantId     String?
  name         String
  description  String?
  isSystem     Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  users        UserRole[]
  permissions  RolePermission[]
  auditLogs    AuditLog[]       @relation("AuditLogRole")

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id          Int               @id @default(autoincrement())
  key         String            @unique
  description String?
  createdAt   DateTime          @default(now())
  roles       RolePermission[]
}

model UserRole {
  userId    Int
  roleId    Int
  assignedAt DateTime  @default(now())
  assignedBy Int?
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedByUser User? @relation("UserRoleAssignedBy", fields: [assignedBy], references: [id])

  @@id([userId, roleId])
}

model RolePermission {
  roleId       Int
  permissionId Int
  assignedAt   DateTime  @default(now())
  assignedBy   Int?
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedByUser User?    @relation("RolePermissionAssignedBy", fields: [assignedBy], references: [id])

  @@id([roleId, permissionId])
}

model AuditLog {
  id          Int       @id @default(autoincrement())
  tenantId    String?
  userId      Int?
  roleId      Int?
  actorEmail  String?
  action      String
  entity      String?
  entityId    String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  role        Role?     @relation("AuditLogRole", fields: [roleId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([createdAt])
}

model ApiWebhook {
  id             Int       @id @default(autoincrement())
  tenantId       String?
  event          String
  targetUrl      String
  secret         String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastTriggeredAt DateTime?
  lastError      String?

  @@index([tenantId])
  @@index([event])
}

model CsvExportPreset {
  id          Int      @id @default(autoincrement())
  tenantId    String?
  ownerId     Int?
  name        String
  description String?
  columns     Json
  delimiter   String   @default(",")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  owner       User?    @relation("CsvPresetOwners", fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
}

model DatevExportLog {
  id            Int       @id @default(autoincrement())
  tenantId      String?
  fromDate      DateTime
  toDate        DateTime
  documentCount Int
  totalAmount   Decimal   @db.Decimal(14, 2)
  formatVersion String
  checksum      String?
  fileName      String
  createdAt     DateTime  @default(now())
  triggeredBy   Int?
  user          User?     @relation("DatevExportsTriggered", fields: [triggeredBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([createdAt])
}
